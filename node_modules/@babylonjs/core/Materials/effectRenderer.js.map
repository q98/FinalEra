{"version":3,"file":"effectRenderer.js","sourceRoot":"","sources":["../../../sourceES6/core/Materials/effectRenderer.ts"],"names":[],"mappings":"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","sourcesContent":["import { Nullable } from '../types';\r\nimport { Texture } from '../Materials/Textures/texture';\r\nimport { ThinEngine } from '../Engines/thinEngine';\r\nimport { VertexBuffer } from '../Meshes/buffer';\r\nimport { Viewport } from '../Maths/math.viewport';\r\n\r\nimport { Observable } from '../Misc/observable';\r\nimport { Effect } from './effect';\r\nimport { DataBuffer } from '../Meshes/dataBuffer';\r\n\r\nimport \"../Engines/Extensions/engine.renderTarget\";\r\n\r\n// Prevents ES6 Crash if not imported.\r\nimport \"../Shaders/postprocess.vertex\";\r\n\r\n/**\r\n * Effect Render Options\r\n */\r\nexport interface IEffectRendererOptions {\r\n    /**\r\n     * Defines the vertices positions.\r\n     */\r\n    positions?: number[];\r\n    /**\r\n     * Defines the indices.\r\n     */\r\n    indices?: number[];\r\n}\r\n\r\n/**\r\n * Helper class to render one or more effects\r\n */\r\nexport class EffectRenderer {\r\n    // Fullscreen quad buffers by default.\r\n    private static _DefaultOptions: IEffectRendererOptions = {\r\n        positions: [1, 1, -1, 1, -1, -1, 1, -1],\r\n        indices: [0, 1, 2, 0, 2, 3]\r\n    };\r\n\r\n    private _vertexBuffers: {[key: string]: VertexBuffer};\r\n    private _indexBuffer: DataBuffer;\r\n\r\n    private _ringBufferIndex = 0;\r\n    private _ringScreenBuffer: Nullable<Array<Texture>> = null;\r\n    private _fullscreenViewport = new Viewport(0, 0, 1, 1);\r\n\r\n    private _getNextFrameBuffer(incrementIndex = true) {\r\n        if (!this._ringScreenBuffer) {\r\n            this._ringScreenBuffer = [];\r\n            for (var i = 0; i < 2; i++) {\r\n                var internalTexture = this.engine.createRenderTargetTexture(\r\n                    {\r\n                        width: this.engine.getRenderWidth(true),\r\n                        height: this.engine.getRenderHeight(true),\r\n                    },\r\n                    {\r\n                        generateDepthBuffer: false,\r\n                        generateStencilBuffer: false,\r\n                        generateMipMaps: false,\r\n                        samplingMode: 1,\r\n                    },\r\n                );\r\n                var texture = new Texture(\"\", null);\r\n                texture._texture = internalTexture;\r\n                this._ringScreenBuffer.push(texture);\r\n            }\r\n        }\r\n        var ret = this._ringScreenBuffer[this._ringBufferIndex];\r\n        if (incrementIndex) {\r\n            this._ringBufferIndex = (this._ringBufferIndex + 1) % 2;\r\n        }\r\n        return ret;\r\n    }\r\n\r\n    /**\r\n     * Creates an effect renderer\r\n     * @param engine the engine to use for rendering\r\n     * @param options defines the options of the effect renderer\r\n     */\r\n    constructor(private engine: ThinEngine, options: IEffectRendererOptions = EffectRenderer._DefaultOptions) {\r\n        options = {\r\n            ...EffectRenderer._DefaultOptions,\r\n            ...options,\r\n        };\r\n\r\n        this._vertexBuffers = {\r\n            [VertexBuffer.PositionKind]: new VertexBuffer(engine, options.positions!, VertexBuffer.PositionKind, false, false, 2),\r\n        };\r\n        this._indexBuffer = engine.createIndexBuffer(options.indices!);\r\n\r\n        // No need here for full screen render.\r\n        engine.depthCullingState.depthTest = false;\r\n        engine.stencilState.stencilTest = false;\r\n    }\r\n\r\n    /**\r\n     * Sets the current viewport in normalized coordinates 0-1\r\n     * @param viewport Defines the viewport to set (defaults to 0 0 1 1)\r\n     */\r\n    public setViewport(viewport = this._fullscreenViewport): void {\r\n        this.engine.setViewport(viewport);\r\n    }\r\n\r\n    /**\r\n     * Binds the embedded attributes buffer to the effect.\r\n     * @param effect Defines the effect to bind the attributes for\r\n     */\r\n    public bindBuffers(effect: Effect): void {\r\n        this.engine.bindBuffers(this._vertexBuffers, this._indexBuffer, effect);\r\n    }\r\n\r\n    /**\r\n     * Sets the current effect wrapper to use during draw.\r\n     * The effect needs to be ready before calling this api.\r\n     * This also sets the default full screen position attribute.\r\n     * @param effectWrapper Defines the effect to draw with\r\n     */\r\n    public applyEffectWrapper(effectWrapper: EffectWrapper): void {\r\n        this.engine.enableEffect(effectWrapper.effect);\r\n        this.bindBuffers(effectWrapper.effect);\r\n        effectWrapper.onApplyObservable.notifyObservers({});\r\n    }\r\n\r\n    /**\r\n     * Draws a full screen quad.\r\n     */\r\n    public draw(): void {\r\n        this.engine.drawElementsType(0, 0, 6);\r\n    }\r\n\r\n    /**\r\n     * renders one or more effects to a specified texture\r\n     * @param effectWrappers list of effects to renderer\r\n     * @param outputTexture texture to draw to, if null it will render to the screen\r\n     */\r\n    public render(effectWrappers: Array<EffectWrapper> | EffectWrapper, outputTexture: Nullable<Texture> = null) {\r\n        if (!Array.isArray(effectWrappers)) {\r\n            effectWrappers = [effectWrappers];\r\n        }\r\n\r\n        // Ensure all effects are ready\r\n        for (var wrapper of effectWrappers) {\r\n            if (!wrapper.effect.isReady()) {\r\n                return;\r\n            }\r\n        }\r\n\r\n        effectWrappers.forEach((effectWrapper, i) => {\r\n            var renderTo = outputTexture;\r\n\r\n            // for any next effect make it's input the output of the previous effect\r\n            if (i !== 0) {\r\n                effectWrapper.effect.onBindObservable.addOnce(() => {\r\n                    effectWrapper.effect.setTexture(\"textureSampler\", this._getNextFrameBuffer(false));\r\n                });\r\n            }\r\n\r\n            // Set the output to the next screenbuffer\r\n            if ((effectWrappers as Array<EffectWrapper>).length > 1 && i != (effectWrappers as Array<EffectWrapper>).length - 1) {\r\n                renderTo = this._getNextFrameBuffer();\r\n            } else {\r\n                renderTo = outputTexture;\r\n            }\r\n\r\n            // Reset state\r\n            this.setViewport();\r\n            this.applyEffectWrapper(effectWrapper);\r\n\r\n            if (renderTo) {\r\n                this.engine.bindFramebuffer(renderTo.getInternalTexture()!);\r\n            }\r\n\r\n            this.draw();\r\n\r\n            if (renderTo) {\r\n                this.engine.unBindFramebuffer(renderTo.getInternalTexture()!);\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Disposes of the effect renderer\r\n     */\r\n    dispose() {\r\n        if (this._ringScreenBuffer) {\r\n            this._ringScreenBuffer.forEach((b) => {\r\n                b.dispose();\r\n            });\r\n            this._ringScreenBuffer = null;\r\n        }\r\n\r\n        var vertexBuffer = this._vertexBuffers[VertexBuffer.PositionKind];\r\n        if (vertexBuffer) {\r\n            vertexBuffer.dispose();\r\n            delete this._vertexBuffers[VertexBuffer.PositionKind];\r\n        }\r\n\r\n        if (this._indexBuffer) {\r\n            this.engine._releaseBuffer(this._indexBuffer);\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n * Options to create an EffectWrapper\r\n */\r\ninterface EffectWrapperCreationOptions {\r\n    /**\r\n     * Engine to use to create the effect\r\n     */\r\n    engine: ThinEngine;\r\n    /**\r\n     * Fragment shader for the effect\r\n     */\r\n    fragmentShader: string;\r\n    /**\r\n     * Vertex shader for the effect\r\n     */\r\n    vertexShader?: string;\r\n    /**\r\n     * Attributes to use in the shader\r\n     */\r\n    attributeNames?: Array<string>;\r\n    /**\r\n     * Uniforms to use in the shader\r\n     */\r\n    uniformNames?: Array<string>;\r\n    /**\r\n     * Texture sampler names to use in the shader\r\n     */\r\n    samplerNames?: Array<string>;\r\n    /**\r\n     * The friendly name of the effect displayed in Spector.\r\n     */\r\n    name?: string;\r\n}\r\n\r\n/**\r\n * Wraps an effect to be used for rendering\r\n */\r\nexport class EffectWrapper {\r\n    /**\r\n     * Event that is fired right before the effect is drawn (should be used to update uniforms)\r\n     */\r\n    public onApplyObservable = new Observable<{}>();\r\n    /**\r\n     * The underlying effect\r\n     */\r\n    public effect: Effect;\r\n\r\n    /**\r\n     * Creates an effect to be renderer\r\n     * @param creationOptions options to create the effect\r\n     */\r\n    constructor(creationOptions: EffectWrapperCreationOptions) {\r\n        let effectCreationOptions: any;\r\n        const uniformNames = creationOptions.uniformNames || [];\r\n        if (creationOptions.vertexShader) {\r\n            effectCreationOptions = {\r\n                fragmentSource: creationOptions.fragmentShader,\r\n                vertexSource: creationOptions.vertexShader,\r\n                spectorName: creationOptions.name || \"effectWrapper\"\r\n            };\r\n        }\r\n        else {\r\n            // Default scale to use in post process vertex shader.\r\n            uniformNames.push(\"scale\");\r\n\r\n            effectCreationOptions = {\r\n                fragmentSource: creationOptions.fragmentShader,\r\n                vertex: \"postprocess\",\r\n                spectorName: creationOptions.name || \"effectWrapper\"\r\n            };\r\n\r\n            // Sets the default scale to identity for the post process vertex shader.\r\n            this.onApplyObservable.add(() => {\r\n                this.effect.setFloat2(\"scale\", 1, 1);\r\n            });\r\n        }\r\n\r\n        this.effect = new Effect(effectCreationOptions,\r\n            creationOptions.attributeNames || [\"position\"],\r\n            uniformNames,\r\n            creationOptions.samplerNames,\r\n            creationOptions.engine);\r\n    }\r\n\r\n    /**\r\n    * Disposes of the effect wrapper\r\n    */\r\n    public dispose() {\r\n        this.effect.dispose();\r\n    }\r\n}"]}