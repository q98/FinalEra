{"version":3,"file":"photoDome.js","sourceRoot":"","sources":["../../../sourceES6/core/Helpers/photoDome.ts"],"names":[],"mappings":"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","sourcesContent":["import { Observable, Observer } from \"../Misc/observable\";\r\nimport { Nullable } from \"../types\";\r\nimport { Scene } from \"../scene\";\r\nimport { TransformNode } from \"../Meshes/transformNode\";\r\nimport { Mesh } from \"../Meshes/mesh\";\r\nimport { Texture } from \"../Materials/Textures/texture\";\r\nimport { BackgroundMaterial } from \"../Materials/Background/backgroundMaterial\";\r\nimport \"../Meshes/Builders/sphereBuilder\";\r\nimport { Vector3 } from '../Maths/math.vector';\r\nimport { Camera } from '../Cameras/camera';\r\n\r\n/**\r\n * Display a 360 degree photo on an approximately spherical surface, useful for VR applications or skyboxes.\r\n * As a subclass of TransformNode, this allow parenting to the camera with different locations in the scene.\r\n * This class achieves its effect with a Texture and a correctly configured BackgroundMaterial on an inverted sphere.\r\n * Potential additions to this helper include zoom and and non-infinite distance rendering effects.\r\n */\r\nexport class PhotoDome extends TransformNode {\r\n    /**\r\n     * Define the image as a Monoscopic panoramic 360 image.\r\n     */\r\n    public static readonly MODE_MONOSCOPIC = 0;\r\n    /**\r\n     * Define the image as a Stereoscopic TopBottom/OverUnder panoramic 360 image.\r\n     */\r\n    public static readonly MODE_TOPBOTTOM = 1;\r\n    /**\r\n     * Define the image as a Stereoscopic Side by Side panoramic 360 image.\r\n     */\r\n    public static readonly MODE_SIDEBYSIDE = 2;\r\n\r\n    private _useDirectMapping = false;\r\n\r\n    /**\r\n     * The texture being displayed on the sphere\r\n     */\r\n    protected _photoTexture: Texture;\r\n\r\n    /**\r\n     * Gets or sets the texture being displayed on the sphere\r\n     */\r\n    public get photoTexture(): Texture {\r\n        return this._photoTexture;\r\n    }\r\n\r\n    public set photoTexture(value: Texture) {\r\n        if (this._photoTexture === value) {\r\n            return;\r\n        }\r\n        this._photoTexture = value;\r\n        if (this._useDirectMapping) {\r\n            this._photoTexture.wrapU = Texture.CLAMP_ADDRESSMODE;\r\n            this._photoTexture.wrapV = Texture.CLAMP_ADDRESSMODE;\r\n            this._material.diffuseTexture = this._photoTexture;\r\n        } else {\r\n            this._photoTexture.coordinatesMode = Texture.FIXED_EQUIRECTANGULAR_MIRRORED_MODE; // matches orientation\r\n            this._photoTexture.wrapV = Texture.CLAMP_ADDRESSMODE;\r\n            this._material.reflectionTexture = this._photoTexture;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Observable raised when an error occured while loading the 360 image\r\n     */\r\n    public onLoadErrorObservable = new Observable<string>();\r\n\r\n    /**\r\n     * The skybox material\r\n     */\r\n    protected _material: BackgroundMaterial;\r\n\r\n    /**\r\n     * The surface used for the skybox\r\n     */\r\n    protected _mesh: Mesh;\r\n    /**\r\n     * Gets the mesh used for the skybox.\r\n     */\r\n    public get mesh(): Mesh {\r\n        return this._mesh;\r\n    }\r\n\r\n    /**\r\n     * The current fov(field of view) multiplier, 0.0 - 2.0. Defaults to 1.0. Lower values \"zoom in\" and higher values \"zoom out\".\r\n     * Also see the options.resolution property.\r\n     */\r\n    public get fovMultiplier(): number {\r\n        return this._material.fovMultiplier;\r\n    }\r\n    public set fovMultiplier(value: number) {\r\n        this._material.fovMultiplier = value;\r\n    }\r\n\r\n    private _imageMode = PhotoDome.MODE_MONOSCOPIC;\r\n    /**\r\n     * Gets or set the current video mode for the video. It can be:\r\n     * * PhotoDome.MODE_MONOSCOPIC : Define the image as a Monoscopic panoramic 360 image.\r\n     * * PhotoDome.MODE_TOPBOTTOM  : Define the image as a Stereoscopic TopBottom/OverUnder panoramic 360 image.\r\n     * * PhotoDome.MODE_SIDEBYSIDE : Define the image as a Stereoscopic Side by Side panoramic 360 image.\r\n     */\r\n    public get imageMode(): number {\r\n        return this._imageMode;\r\n    }\r\n    public set imageMode(value: number) {\r\n        if (this._imageMode === value) {\r\n            return;\r\n        }\r\n\r\n        this._changeImageMode(value);\r\n    }\r\n\r\n    /**\r\n     * Create an instance of this class and pass through the parameters to the relevant classes, Texture, StandardMaterial, and Mesh.\r\n     * @param name Element's name, child elements will append suffixes for their own names.\r\n     * @param urlsOfPhoto defines the url of the photo to display\r\n     * @param options defines an object containing optional or exposed sub element properties\r\n     * @param onError defines a callback called when an error occured while loading the texture\r\n     */\r\n    constructor(name: string, urlOfPhoto: string, options: {\r\n        resolution?: number,\r\n        size?: number,\r\n        useDirectMapping?: boolean,\r\n        faceForward?: boolean\r\n    }, scene: Scene, onError: Nullable<(message?: string, exception?: any) => void> = null) {\r\n        super(name, scene);\r\n\r\n        // set defaults and manage values\r\n        name = name || \"photoDome\";\r\n        options.resolution = (Math.abs(options.resolution as any) | 0) || 32;\r\n        options.size = Math.abs(options.size as any) || (scene.activeCamera ? scene.activeCamera.maxZ * 0.48 : 1000);\r\n\r\n        if (options.useDirectMapping === undefined) {\r\n            this._useDirectMapping = true;\r\n        } else {\r\n            this._useDirectMapping = options.useDirectMapping;\r\n        }\r\n\r\n        if (options.faceForward === undefined) {\r\n            options.faceForward = true;\r\n        }\r\n\r\n        this._setReady(false);\r\n\r\n        // create\r\n        let material = this._material = new BackgroundMaterial(name + \"_material\", scene);\r\n        this._mesh = Mesh.CreateSphere(name + \"_mesh\", options.resolution, options.size, scene, false, Mesh.BACKSIDE);\r\n\r\n        // configure material\r\n        material.opacityFresnel = false;\r\n        material.useEquirectangularFOV = true;\r\n        material.fovMultiplier = 1.0;\r\n\r\n        this.photoTexture = new Texture(urlOfPhoto, scene, true, !this._useDirectMapping, undefined, undefined, (message, exception) => {\r\n            this.onLoadErrorObservable.notifyObservers(message || \"Unknown error occured\");\r\n\r\n            if (onError) {\r\n                onError(message, exception);\r\n            }\r\n        });\r\n        this.photoTexture.anisotropicFilteringLevel = 1;\r\n\r\n        this.photoTexture.onLoadObservable.addOnce(() => {\r\n            this._setReady(true);\r\n        });\r\n\r\n        // configure mesh\r\n        this._mesh.material = material;\r\n        this._mesh.parent = this;\r\n\r\n        // Initial rotation\r\n        if (options.faceForward && scene.activeCamera) {\r\n            let camera = scene.activeCamera;\r\n\r\n            let forward = Vector3.Forward();\r\n            var direction = Vector3.TransformNormal(forward, camera.getViewMatrix());\r\n            direction.normalize();\r\n\r\n            this.rotation.y = Math.acos(Vector3.Dot(forward, direction));\r\n        }\r\n    }\r\n\r\n    private _onBeforeCameraRenderObserver: Nullable<Observer<Camera>> = null;\r\n\r\n    private _changeImageMode(value: number): void {\r\n        this._scene.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver);\r\n        this._imageMode = value;\r\n\r\n        // Default Setup and Reset.\r\n        this._photoTexture.uScale = 1;\r\n        this._photoTexture.vScale = 1;\r\n        this._photoTexture.uOffset = 0;\r\n        this._photoTexture.vOffset = 0;\r\n\r\n        switch (value) {\r\n            case PhotoDome.MODE_SIDEBYSIDE:\r\n                this._photoTexture.uScale = 0.5;\r\n                this._onBeforeCameraRenderObserver = this._scene.onBeforeCameraRenderObservable.add((camera) => {\r\n                    this._photoTexture.uOffset = camera.isRightCamera ? 0.5 : 0.0;\r\n                });\r\n                break;\r\n            case PhotoDome.MODE_TOPBOTTOM:\r\n                this._photoTexture.vScale = 0.5;\r\n                this._onBeforeCameraRenderObserver = this._scene.onBeforeCameraRenderObservable.add((camera) => {\r\n                    this._photoTexture.vOffset = camera.isRightCamera ? 0.5 : 0.0;\r\n                });\r\n                break;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Releases resources associated with this node.\r\n     * @param doNotRecurse Set to true to not recurse into each children (recurse into each children by default)\r\n     * @param disposeMaterialAndTextures Set to true to also dispose referenced materials and textures (false by default)\r\n     */\r\n    public dispose(doNotRecurse?: boolean, disposeMaterialAndTextures = false): void {\r\n        this._photoTexture.dispose();\r\n        this._mesh.dispose();\r\n        this._material.dispose();\r\n\r\n        this.onLoadErrorObservable.clear();\r\n\r\n        this._scene.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver);\r\n\r\n        super.dispose(doNotRecurse, disposeMaterialAndTextures);\r\n    }\r\n}\r\n"]}